# Data Model: 消息与结构化产出分离存储

## Entities

### ConversationMessage
Represents a single message in a scenario conversation, with both text and structured payload.

- **Fields**
  - `id` (pk)
  - `scenarioId` (fk → Scenario)
  - `role` (enum: user | assistant | system)
  - `content` (text, required)
  - `structuredData` (jsonb, nullable) — AI structured output
  - `requestLog` (jsonb, nullable)
  - `responseStats` (jsonb, nullable)
  - `timestamp` (timestamp, required)
  - `createdAt` (timestamp, required)
- **Validation Rules**
  - `content` must be non-empty
  - `structuredData`, `requestLog`, `responseStats` must be valid JSON when provided
- **Relationships**
  - Belongs to Scenario
  - Has many AnalysisArtifacts

### AnalysisSubject
Extracted accounting subject generated by AI analysis.

- **Fields**
  - `id` (pk)
  - `scenarioId` (fk → Scenario)
  - `sourceMessageId` (fk → ConversationMessage)
  - `code` (string, required)
  - `name` (string, required)
  - `direction` (enum: debit | credit | both)
  - `description` (text, optional)
  - `metadata` (jsonb, optional)
  - `createdAt` (timestamp, required)
- **Validation Rules**
  - `code` and `name` required

### AnalysisEntry
Extracted journal entry generated by AI analysis.

- **Fields**
  - `id` (pk)
  - `scenarioId` (fk → Scenario)
  - `sourceMessageId` (fk → ConversationMessage)
  - `lines` (jsonb, required) — array of debit/credit line items
  - `description` (text, optional)
  - `amount` (numeric, optional)
  - `currency` (string, optional)
  - `metadata` (jsonb, optional)
  - `createdAt` (timestamp, required)
- **Validation Rules**
  - `lines` must contain at least one debit and one credit line

### AnalysisDiagram
Extracted diagram or chart generated by AI analysis.

- **Fields**
  - `id` (pk)
  - `scenarioId` (fk → Scenario)
  - `sourceMessageId` (fk → ConversationMessage)
  - `diagramType` (enum: mermaid | chart | table)
  - `payload` (text/jsonb, required)
  - `metadata` (jsonb, optional)
  - `createdAt` (timestamp, required)
- **Validation Rules**
  - `payload` must be present

### JournalRule (updated)
Executable journal rule with structured debit/credit sides.

- **Fields (existing)**
  - `id`, `scenarioId`, `eventName`, `eventDescription`, `conditions`, `amountFormula`, `createdAt`, `updatedAt`
- **New Fields**
  - `debitSide` (jsonb, required) — structured debit definition
  - `creditSide` (jsonb, required) — structured credit definition
  - `triggerType` (string, required)
  - `status` (enum: proposal | confirmed, required)
- **Validation Rules**
  - `debitSide` and `creditSide` must be present before setting `status=confirmed`
  - `amountFormula` is optional and human-readable only

## Relationships Summary

- Scenario → ConversationMessage (1:N)
- ConversationMessage → AnalysisSubject/AnalysisEntry/AnalysisDiagram (1:N)
- Scenario → JournalRule (1:N)

## State Transitions

### JournalRule.status
- `proposal` → `confirmed` allowed only when `debitSide` and `creditSide` are valid
- `confirmed` → `proposal` allowed for edits or rollback
