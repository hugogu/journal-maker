# Feature Specification: AI辅助会计规则分析工具 MVP

**Feature Branch**: `001-accounting-ai-mvp`  
**Created**: 2025-02-01  
**Status**: Draft  
**Input**: User description: "完成MVP，包括以下功能通过AI辅助人来梳理、分析业务中涉及资金的信息流和资金流、参与方的权责关系等信息，来确定每个产品每个业务场景的记账规则的一个轻量级的页面端应用。主要有两类用户，一类是管理员，他有已经分析好的一个产品中的一个场景的科目及会计规则作为范例，也可以配置AI API及Key，并为AI编辑Prompt，提供公共的基础信息给到AI，另一类用户是产品，产品会来给出新的场景的相关信息，以便让AI辅助分析出新场景下的科目和会计规则。所有的科目在所有场景中应该是共享的，所有人都可以看到和调整这些科目。AI在进行分析时，结合现有的科目、范例，通过澄清不清楚的描述等方式，引导出在这个场景下最合理的科目及会计分录设计。整个服务将以场景作为每次分析的上下文，同时也有地方定义公司整体级别的信息，以避免在每次分析中重复。分析的结果应该足够的格式化（如通过格式化的表格或JSON）以便导出，在通过对话分析的过程中，这个应用可以通过分析AI的结果，将特定场景的信息流、资金流、相关方的权责关系以流程图的方式实时呈现给用户，同时以一个交易为例，生成当前场景下的一个交易流程的完整的示例记账数据（这也是通过独立的后台AI会话来完成的，只是不需要用户自己提出来，而且需要有完整的友好的美观的页面呈现）整个项目的技术体系和部署尽量轻量化，需要能用docker在本地运行。其中数据库可以独立，数据库中存储的主要数据包括AI配置、会计科目、每个场景已经确定的分录设计。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 管理员配置AI和基准范例 (Priority: P1)

管理员首次使用系统时，需要配置AI服务连接信息、编辑系统级Prompt模板，并创建一个基准业务场景作为后续分析的范例。这是系统运行的基础配置。

**Why this priority**: 没有AI配置和基准范例，产品用户无法进行场景分析。这是整个系统运转的前提条件。

**Independent Test**: 可以独立测试：管理员完成配置后，系统能够成功调用AI API并返回结构化响应。

**Acceptance Scenarios**:

1. **Given** 管理员首次访问系统，**When** 进入AI配置页面，**Then** 可以输入API端点、API Key、选择模型类型
2. **Given** 管理员在AI配置页面，**When** 编辑系统Prompt模板，**Then** 可以保存版本化的Prompt，包含变量占位符（如{{company_info}}, {{accounts}}, {{example_scenario}}）
3. **Given** 管理员已配置AI，**When** 创建第一个基准场景（如"标准电商订单"），**Then** 可以定义该场景的信息流、资金流、权责关系，并得到AI辅助生成的科目和会计分录
4. **Given** 基准场景已创建，**When** 管理员保存场景，**Then** 该场景被标记为"范例"，可供后续场景分析时引用

---

### User Story 2 - 共享科目管理 (Priority: P1)

所有用户（管理员和产品）可以查看、添加、修改会计科目。科目在所有场景中共享，是AI分析的基础词汇表。

**Why this priority**: 科目是AI分析的核心输入，必须在场景分析前建立。共享机制确保一致性。

**Independent Test**: 可以独立测试：用户能够CRUD科目，修改后影响所有场景。

**Acceptance Scenarios**:

1. **Given** 用户访问科目管理页面，**When** 浏览科目列表，**Then** 可以看到完整的科目体系（科目代码、名称、类型、方向、说明）
2. **Given** 用户在科目管理页面，**When** 添加新科目，**Then** 系统验证科目代码唯一性，并自动同步到所有场景
3. **Given** 用户编辑已有科目，**When** 修改科目名称或说明，**Then** 历史场景中的引用保持不变，但显示更新后的信息
4. **Given** 用户尝试删除已被场景使用的科目，**When** 执行删除操作，**Then** 系统提示"该科目已被N个场景使用，无法删除"

---

### User Story 3 - 产品用户分析新场景 (Priority: P1)

产品用户描述一个新的业务场景，AI结合现有科目和范例，通过对话引导澄清模糊点，最终生成该场景下的会计分录设计。

**Why this priority**: 这是产品的核心价值功能，用户的主要使用场景。

**Independent Test**: 可以独立测试：产品用户完成场景描述后，AI返回结构化的科目映射和会计分录建议。

**Acceptance Scenarios**:

1. **Given** 产品用户创建新场景，**When** 输入场景名称和描述（如"预售定金模式"），**Then** 系统自动加载公司基础信息和共享科目作为上下文
2. **Given** 场景已创建，**When** 用户补充业务细节（参与方、资金流向、时间节点），**Then** AI主动提出澄清问题（如"定金是否可退？""何时确认收入？"）
3. **Given** AI已提出澄清问题，**When** 用户回答问题，**Then** AI基于回答更新分析，逐步完善科目映射
4. **Given** 对话分析完成，**When** AI生成分录建议，**Then** 以结构化表格呈现（借方科目、贷方科目、金额计算逻辑、触发条件）

---

### User Story 4 - 实时流程图可视化 (Priority: P2)

在AI分析过程中，系统自动解析AI的输出，将场景的信息流、资金流、权责关系以流程图形式实时呈现。

**Why this priority**: 可视化帮助用户理解复杂业务逻辑，但不是阻塞性功能。

**Independent Test**: 可以独立测试：给定AI的结构化输出，页面渲染出可交互的流程图。

**Acceptance Scenarios**:

1. **Given** AI分析了场景的资金流向，**When** 返回包含资金节点的结构化数据，**Then** 页面自动渲染资金流流程图（节点：用户支付、平台代收、商家结算、平台抽成）
2. **Given** AI分析了权责关系，**When** 返回参与方和职责，**Then** 流程图显示各方在时间轴上的责任边界
3. **Given** 流程图已渲染，**When** 用户点击某个节点，**Then** 显示该节点对应的会计分录片段
4. **Given** AI更新了分析结果，**When** 数据结构变化，**Then** 流程图实时更新，保持布局稳定

---

### User Story 5 - 示例交易记账数据生成 (Priority: P2)

场景分析完成后，系统自动生成一个完整交易示例的记账数据，展示从业务发生到会计入账的全流程。

**Why this priority**: 帮助用户验证分录设计的正确性，提供直观的参考案例。

**Independent Test**: 可以独立测试：场景分析完成后，后台触发AI会话生成示例数据，前端展示完整记账流水。

**Acceptance Scenarios**:

1. **Given** 场景分析已完成并确认，**When** 系统自动触发后台AI会话，**Then** 生成该场景下典型交易的完整记账数据（不阻塞用户操作）
2. **Given** 示例数据已生成，**When** 用户查看示例交易页面，**Then** 看到美观的记账凭证列表（凭证号、日期、摘要、借贷方科目、金额）
3. **Given** 示例包含多步骤交易（如"下单-支付-发货-确认"），**When** 用户浏览，**Then** 看到时间轴形式的分录序列，标注每个业务事件触发的会计处理
4. **Given** 示例数据展示中，**When** 用户点击某笔分录，**Then** 展开显示该分录的业务背景说明和计算逻辑

---

### User Story 6 - 结构化导出 (Priority: P2)

用户可以将分析结果（科目映射、会计规则、示例数据）导出为结构化格式，便于与其他系统集成。

**Why this priority**: 导出功能支持下游系统对接，但MVP阶段可手动复制作为替代方案。

**Independent Test**: 可以独立测试：点击导出按钮，生成符合格式的文件并下载。

**Acceptance Scenarios**:

1. **Given** 场景分析已完成，**When** 用户点击"导出JSON"，**Then** 下载包含完整场景定义、科目映射、分录规则的JSON文件
2. **Given** 场景分析已完成，**When** 用户点击"导出Excel"，**Then** 下载包含会计科目表、分录规则表、示例交易明细的Excel工作簿
3. **Given** 用户选择导出格式，**When** 系统生成文件，**Then** 文件名包含场景名称和版本号（如"预售定金模式_v1_20250201.json"）

---

### Edge Cases

1. **AI API调用失败**: 当AI服务不可用时，系统应提示用户检查配置，并允许重试。历史分析结果不应丢失。
2. **AI返回非结构化数据**: 当AI未按预期格式返回时，系统应尝试解析，若失败则展示原始响应并提示用户手动处理。
3. **并发编辑科目**: 两个用户同时修改同一科目时，后保存的应收到冲突提示，可选择覆盖或合并。
4. **场景依赖的科目被删除**: 若某场景引用的科目被删除，该场景应标记为"不完整"，提示用户修复科目映射。
5. **长时间AI对话**: 当对话轮次超过20轮时，系统应提示用户"建议保存当前进度并开启新会话"，避免上下文过长。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须支持两类用户角色：管理员和产品用户，角色决定可访问的功能模块
- **FR-002**: 管理员必须能够配置AI服务参数（API端点、Key、模型类型），参数加密存储
- **FR-003**: 管理员必须能够编辑系统级Prompt模板，支持变量占位符（如{{accounts}}），Prompt版本化管理
- **FR-004**: 管理员必须能够创建基准范例场景，包含完整的业务描述、科目映射、会计分录
- **FR-005**: 所有用户必须能够查看、添加、编辑会计科目，科目属性包括：代码、名称、类型（资产/负债/权益/收入/费用）、余额方向、说明
- **FR-006**: 系统必须保证科目在所有场景中共享，科目变更实时同步到所有引用它的场景
- **FR-007**: 产品用户必须能够创建新场景，输入场景名称、业务描述、参与方信息
- **FR-008**: 系统必须在每次AI分析时自动加载公司基础信息和当前科目表作为上下文
- **FR-009**: AI必须通过对话形式引导用户澄清业务细节，主动提出针对性的问题
- **FR-010**: AI分析结果必须以结构化格式呈现，包括：科目映射表、会计分录规则表、触发条件说明
- **FR-011**: 系统必须能够解析AI的结构化输出，实时渲染信息流、资金流、权责关系的流程图
- **FR-012**: 流程图必须支持交互：点击节点显示对应分录，缩放、拖拽浏览
- **FR-013**: 场景分析确认后，系统必须自动触发后台AI会话生成完整示例交易记账数据
- **FR-014**: 示例记账数据必须以美观的凭证形式展示，包含时间轴视图和详细分录视图
- **FR-015**: 用户必须能够将分析结果导出为JSON和Excel格式，包含完整的场景定义和规则

### Key Entities

- **Company**: 公司基础信息，作为AI分析的上下文。属性：公司名称、行业、会计准则、默认币种、备注
- **Account**: 会计科目，全局共享。属性：科目代码、科目名称、科目类型（资产/负债/权益/收入/费用）、余额方向（借/贷）、状态（启用/停用）、创建时间、更新时间
- **User**: 系统用户。属性：用户ID、用户名、角色（admin/product）、创建时间
- **AIConfig**: AI服务配置，全局唯一。属性：API端点、加密存储的API Key、模型类型、默认温度参数、系统Prompt模板、版本号
- **Scenario**: 业务场景。属性：场景ID、场景名称、业务描述、参与方信息、创建者、状态（draft/analyzing/confirmed）、是否范例标记、关联的科目映射、创建的会计分录规则、创建时间、更新时间
- **AccountMapping**: 场景内的科目映射。属性：映射ID、场景ID、科目代码、业务角色（如"平台收入"）、计算逻辑、说明
- **JournalRule**: 会计分录规则。属性：规则ID、场景ID、规则名称、触发条件、借贷方科目及金额计算逻辑、示例说明
- **Conversation**: AI对话记录。属性：对话ID、场景ID、消息列表（角色/内容/时间）、对话状态、结构化结果缓存
- **SampleTransaction**: 示例交易。属性：示例ID、场景ID、交易名称、交易步骤列表（步骤序号、业务事件、分录列表）
- **FlowchartData**: 流程图数据。属性：场景ID、节点列表（ID/类型/标签/位置）、边列表（起点/终点/标签）、最后更新时间

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 管理员能够在5分钟内完成AI配置和基准场景创建
- **SC-002**: 产品用户能够在10分钟内完成新场景的基础描述并开始AI分析
- **SC-003**: AI能够在3轮对话内识别场景中的关键业务节点（资金流转点、权责转移点）
- **SC-004**: 流程图渲染延迟不超过2秒（从AI返回结构化数据到可视化呈现）
- **SC-005**: 示例交易数据在场景确认后30秒内自动生成并展示
- **SC-006**: 科目管理操作的响应时间不超过1秒（增删改查）
- **SC-007**: 场景分析结果导出文件大小控制在1MB以内（支持大文件分片）
- **SC-008**: 系统能够在Docker环境中通过单命令（docker-compose up）在3分钟内完成启动
- **SC-009**: 90%的用户能够在无培训的情况下完成首次场景分析（通过引导式UI设计）
- **SC-010**: AI生成的结构化数据解析成功率不低于95%（非结构化回退为原文展示）

## Assumptions & Dependencies

### Assumptions

- **A-001**: 用户具备基础会计知识，能够理解科目和分录概念
- **A-002**: AI服务支持OpenAI兼容的API格式（支持自定义端点）
- **A-003**: 业务场景的分析深度以中等复杂度为限（参与方不超过5个，资金节点不超过10个）
- **A-004**: 同时在线用户数不超过20人（轻量级内部工具场景）

### Dependencies

- **DEP-001**: 需要OpenAI或兼容的AI服务API访问权限
- **DEP-002**: Docker和Docker Compose运行环境
- **DEP-003**: PostgreSQL 15+ 数据库（可通过Docker提供）
